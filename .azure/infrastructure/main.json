{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Asserts"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "12211050883136534926"
    }
  },
  "definitions": {
    "_1.HostNameConfiguration": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "sslCertificateSecretKey": {
          "type": "string"
        },
        "redirectTo": {
          "type": "string",
          "nullable": true
        },
        "enableAvailabilityTest": {
          "type": "bool"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/applicationGateway/main.bicep"
        }
      }
    },
    "ApplicationGatewayConfiguration": {
      "type": "object",
      "properties": {
        "sku": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "allowedValues": [
                "Standard_v2",
                "WAF_v2"
              ]
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "Standard_v2",
                "WAF_v2"
              ]
            },
            "capacity": {
              "type": "int",
              "nullable": true
            }
          }
        },
        "autoscaleConfiguration": {
          "type": "object",
          "properties": {
            "minCapacity": {
              "type": "int"
            },
            "maxCapacity": {
              "type": "int"
            }
          },
          "nullable": true
        },
        "hostNames": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_1.HostNameConfiguration"
          },
          "minLength": 1,
          "metadata": {
            "description": "Array of hostnames. Exactly one must be marked as primary (isPrimary: true)."
          }
        },
        "sslCertificateKeyVaultName": {
          "type": "string"
        },
        "zones": {
          "type": "array",
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/applicationGateway/main.bicep"
        }
      }
    },
    "PostgreSQLHighAvailabilityConfiguration": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "allowedValues": [
            "Disabled",
            "SameZone",
            "ZoneRedundant"
          ]
        },
        "standbyAvailabilityZone": {
          "type": "string",
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/postgreSql/create.bicep"
        }
      }
    },
    "PostgreSQLSku": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "allowedValues": [
            "Standard_B12ms",
            "Standard_B16ms",
            "Standard_B1ms",
            "Standard_B20ms",
            "Standard_B2s",
            "Standard_B4ms",
            "Standard_B8ms",
            "Standard_D2ads_v5",
            "Standard_D4ads_v5",
            "Standard_D8ads_v5"
          ]
        },
        "tier": {
          "type": "string",
          "allowedValues": [
            "Burstable",
            "GeneralPurpose",
            "MemoryOptimized"
          ]
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/postgreSql/create.bicep"
        }
      }
    },
    "PostgreSQLStorageConfiguration": {
      "type": "object",
      "properties": {
        "storageSizeGB": {
          "type": "int",
          "minValue": 32
        },
        "autoGrow": {
          "type": "string",
          "allowedValues": [
            "Disabled",
            "Enabled"
          ]
        },
        "type": {
          "type": "string",
          "allowedValues": [
            "PremiumV2_LRS",
            "Premium_LRS"
          ],
          "metadata": {
            "description": "The type of storage account to use. Default is Premium_LRS."
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/postgreSql/create.bicep"
        }
      }
    },
    "RedisSku": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "allowedValues": [
            "Basic",
            "Premium",
            "Standard"
          ]
        },
        "family": {
          "type": "string",
          "allowedValues": [
            "C",
            "P"
          ]
        },
        "capacity": {
          "type": "int",
          "minValue": 1
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../modules/redis/main.bicep"
        }
      }
    }
  },
  "parameters": {
    "environment": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "keyVaultSourceKeys": {
      "type": "array"
    },
    "dialogportenPgAdminPassword": {
      "type": "securestring",
      "minLength": 3
    },
    "sourceKeyVaultSubscriptionId": {
      "type": "securestring",
      "minLength": 3
    },
    "sourceKeyVaultResourceGroup": {
      "type": "securestring",
      "minLength": 3
    },
    "sourceKeyVaultName": {
      "type": "securestring",
      "minLength": 3
    },
    "sourceKeyVaultSshJumperSshPublicKey": {
      "type": "securestring",
      "minLength": 3,
      "metadata": {
        "description": "SSH public key for the ssh jumper"
      }
    },
    "entraDevelopersGroupId": {
      "type": "string",
      "metadata": {
        "description": "The object ID of the group to assign the Admin Login role for SSH Jumper and Storage Blob Data Reader role for source maps"
      }
    },
    "containerAppEnvZoneRedundancyEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to enable zone redundancy for the container app environment"
      }
    },
    "containerAppEnvWorkloadProfiles": {
      "type": "array",
      "defaultValue": [
        {
          "name": "Consumption",
          "workloadProfileType": "Consumption"
        }
      ],
      "metadata": {
        "description": "Workload profiles to enable in the container app environment"
      }
    },
    "redisSku": {
      "$ref": "#/definitions/RedisSku"
    },
    "redisVersion": {
      "type": "string",
      "minLength": 1
    },
    "applicationGatewayConfiguration": {
      "$ref": "#/definitions/ApplicationGatewayConfiguration"
    },
    "applicationGatewayWhitelistedIps": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional list of IP addresses/ranges to whitelist for incoming traffic"
      }
    },
    "enableMaintenancePage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable maintenance mode to redirect all traffic to maintenance page"
      }
    },
    "enableBackupVault": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to provision the backup vault storage account + container (env-specific, controlled via bicepparam)"
      }
    },
    "postgresConfiguration": {
      "type": "object",
      "properties": {
        "sku": {
          "$ref": "#/definitions/PostgreSQLSku"
        },
        "storage": {
          "$ref": "#/definitions/PostgreSQLStorageConfiguration"
        },
        "highAvailability": {
          "$ref": "#/definitions/PostgreSQLHighAvailabilityConfiguration",
          "nullable": true
        },
        "backupRetentionDays": {
          "type": "int"
        },
        "availabilityZone": {
          "type": "string"
        },
        "version": {
          "type": "string"
        }
      }
    }
  },
  "variables": {
    "secrets": {
      "dialogportenPgAdminPassword": "[parameters('dialogportenPgAdminPassword')]",
      "sourceKeyVaultSubscriptionId": "[parameters('sourceKeyVaultSubscriptionId')]",
      "sourceKeyVaultResourceGroup": "[parameters('sourceKeyVaultResourceGroup')]",
      "sourceKeyVaultName": "[parameters('sourceKeyVaultName')]",
      "sourceKeyVaultSshJumperSshPublicKey": "[parameters('sourceKeyVaultSshJumperSshPublicKey')]"
    },
    "srcKeyVault": {
      "name": "[variables('secrets').sourceKeyVaultName]",
      "subscriptionId": "[variables('secrets').sourceKeyVaultSubscriptionId]",
      "resourceGroupName": "[variables('secrets').sourceKeyVaultResourceGroup]"
    },
    "tags": {
      "Environment": "[parameters('environment')]",
      "Product": "Arbeidsflate"
    },
    "namePrefix": "[format('dp-fe-{0}', parameters('environment'))]",
    "availabilityTestHostNames": "[filter(parameters('applicationGatewayConfiguration').hostNames, lambda('h', lambdaVariables('h').enableAvailabilityTest))]"
  },
  "resources": {
    "resourceGroup": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-rg', variables('namePrefix'))]",
      "location": "[parameters('location')]"
    },
    "srcKeyVaultResource": {
      "existing": true,
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "subscriptionId": "[variables('secrets').sourceKeyVaultSubscriptionId]",
      "resourceGroup": "[variables('secrets').sourceKeyVaultResourceGroup]",
      "name": "[variables('secrets').sourceKeyVaultName]"
    },
    "vnet": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "vnet",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "applicationGatewayWhitelistedIps": {
            "value": "[parameters('applicationGatewayWhitelistedIps')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "17661235469219594339"
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix used for naming resources to ensure unique names"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            },
            "applicationGatewayWhitelistedIps": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional list of IP addresses/ranges to whitelist for incoming traffic"
              }
            }
          },
          "variables": {
            "vnetAddressPrefix": "10.0.0.0/16",
            "defaultSubnetAddressPrefix": "10.0.0.0/24",
            "applicationGatewaySubnetAddressPrefix": "10.0.1.0/24",
            "containerAppEnvSubnetAddressPrefix": "10.0.2.0/23",
            "postgresqlSubnetAddressPrefix": "10.0.4.0/24",
            "redisSubnetAddressPrefix": "10.0.5.0/24",
            "sshJumperSubnetAddressPrefix": "10.0.6.0/24",
            "commonHttpProperties": {
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "direction": "Inbound",
              "sourcePortRanges": [],
              "destinationPortRanges": [
                "80",
                "443"
              ],
              "sourceAddressPrefixes": [],
              "destinationAddressPrefixes": []
            },
            "allowAllHttpRule": {
              "name": "AllowAnyIncomingHttpTraffic",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "properties": "[union(variables('commonHttpProperties'), createObject('sourceAddressPrefix', '*', 'access', 'Allow', 'priority', 110))]"
            },
            "whitelistedHttpRule": {
              "name": "AllowWhitelistedIncomingHttpTraffic",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "properties": "[union(variables('commonHttpProperties'), createObject('sourceAddressPrefixes', parameters('applicationGatewayWhitelistedIps'), 'access', 'Allow', 'priority', 110))]"
            },
            "denyOtherHttpRule": {
              "name": "DenyAllOtherIncomingHttpTraffic",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "properties": "[union(variables('commonHttpProperties'), createObject('sourceAddressPrefix', '*', 'access', 'Deny', 'priority', 120))]"
            },
            "applicationGatewayNSGHttpRules": "[if(empty(parameters('applicationGatewayWhitelistedIps')), createArray(variables('allowAllHttpRule')), createArray(variables('whitelistedHttpRule'), variables('denyOtherHttpRule')))]"
          },
          "resources": {
            "applicationGatewayNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-application-gateway-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": "[concat(createArray(createObject('name', 'AllowAnyCustom65200-65535Inbound', 'type', 'Microsoft.Network/networkSecurityGroups/securityRules', 'properties', createObject('protocol', '*', 'sourcePortRange', '*', 'destinationPortRange', '65200-65535', 'sourceAddressPrefix', '*', 'destinationAddressPrefix', '*', 'access', 'Allow', 'priority', 100, 'direction', 'Inbound', 'sourcePortRanges', createArray(), 'destinationPortRanges', createArray(), 'sourceAddressPrefixes', createArray(), 'destinationAddressPrefixes', createArray()))), variables('applicationGatewayNSGHttpRules'))]"
              },
              "tags": "[parameters('tags')]"
            },
            "defaultNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-default-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAnyCustomAnyInbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAnyCustomAnyOutbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            "containerAppEnvironmentNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-container-app-environment-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAnyCustomAnyOutbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Outbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "container-app",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "container-app-environment",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "10.0.0.62",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "load-balancer",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "30000-32767",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 140,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "AllowAnyCustomAnyInbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 150,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            "postgresqlNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-postgresql-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAnyCustomAnyInbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAnyCustomAnyOutbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            "redisNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-redis-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAnyCustomAnyInbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAnyCustomAnyOutbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            "sshJumperNSG": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-ssh-jumper-nsg', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAnyCustomAnyOutbound",
                    "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            "virtualNetwork": {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-vnet', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "default",
                    "properties": {
                      "addressPrefix": "[variables('defaultSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-default-nsg', parameters('namePrefix')))]"
                      }
                    }
                  },
                  {
                    "name": "applicationGatewaySubnet",
                    "properties": {
                      "addressPrefix": "[variables('applicationGatewaySubnetAddressPrefix')]",
                      "privateLinkServiceNetworkPolicies": "Disabled",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-application-gateway-nsg', parameters('namePrefix')))]"
                      }
                    }
                  },
                  {
                    "name": "containerAppEnvSubnet",
                    "properties": {
                      "addressPrefix": "[variables('containerAppEnvSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-container-app-environment-nsg', parameters('namePrefix')))]"
                      },
                      "privateLinkServiceNetworkPolicies": "Disabled",
                      "delegations": [
                        {
                          "name": "containerAppEnvironment",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "postgresqlSubnet",
                    "properties": {
                      "addressPrefix": "[variables('postgresqlSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-postgresql-nsg', parameters('namePrefix')))]"
                      },
                      "delegations": [
                        {
                          "name": "postgresql",
                          "properties": {
                            "serviceName": "Microsoft.DBforPostgreSQL/flexibleServers"
                          }
                        }
                      ],
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        }
                      ]
                    }
                  },
                  {
                    "name": "redisSubnet",
                    "properties": {
                      "addressPrefix": "[variables('redisSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-redis-nsg', parameters('namePrefix')))]"
                      }
                    }
                  },
                  {
                    "name": "sshJumperSubnet",
                    "properties": {
                      "addressPrefix": "[variables('sshJumperSubnetAddressPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-ssh-jumper-nsg', parameters('namePrefix')))]"
                      }
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "applicationGatewayNSG",
                "containerAppEnvironmentNSG",
                "defaultNSG",
                "postgresqlNSG",
                "redisNSG",
                "sshJumperNSG"
              ]
            }
          },
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[format('{0}-vnet', parameters('namePrefix'))]"
            },
            "virtualNetworkId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('namePrefix')))]"
            },
            "defaultSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'default')]"
            },
            "applicationGatewaySubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'applicationGatewaySubnet')]"
            },
            "containerAppEnvironmentSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'containerAppEnvSubnet')]"
            },
            "postgresqlSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'postgresqlSubnet')]"
            },
            "redisSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'redisSubnet')]"
            },
            "sshJumperSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('{0}-vnet', parameters('namePrefix')), 'sshJumperSubnet')]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "environmentKeyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyVault",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "15128924750209306743"
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "adminObjectIds": {
              "type": "array",
              "defaultValue": []
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "adminAccessPolicies",
                "count": "[length(parameters('adminObjectIds'))]",
                "input": {
                  "objectId": "[parameters('adminObjectIds')[copyIndex('adminAccessPolicies')]]",
                  "tenantId": "[subscription().tenantId]",
                  "permissions": {
                    "keys": [
                      "all"
                    ],
                    "secrets": [
                      "all"
                    ],
                    "certificates": [
                      "all"
                    ]
                  }
                }
              }
            ],
            "keyvaultName": "[take(format('{0}-kv-{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)), 24)]"
          },
          "resources": {
            "keyvault": {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyvaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "enablePurgeProtection": true,
                "enabledForTemplateDeployment": false,
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": "[variables('adminAccessPolicies')]",
                "enableRbacAuthorization": true
              },
              "tags": "[parameters('tags')]"
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "value": "[variables('keyvaultName')]"
            },
            "vaultUri": {
              "type": "string",
              "value": "[reference('keyvault').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "appInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appInsights",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sourceMapsReaderGroupObjectId": {
            "value": "[parameters('entraDevelopersGroupId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "10008234473450940095"
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            },
            "sourceMapContainerName": {
              "type": "string",
              "defaultValue": "sourcemaps",
              "metadata": {
                "description": "The blob container name for source maps"
              }
            },
            "sourceMapsReaderGroupObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the group to assign the Storage Blob Data Reader role to"
              }
            }
          },
          "variables": {
            "sourceMapStorageAccountName": "[substring(replace(format('{0}sourcemaps{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', ''), 0, 24)]",
            "sourceMapUri": "[format('https://{0}.blob.{1}/{2}', variables('sourceMapStorageAccountName'), environment().suffixes.storage, parameters('sourceMapContainerName'))]"
          },
          "resources": {
            "appInsightsWorkspace": {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-insightsWorkspace', parameters('namePrefix'))]",
              "location": "[parameters('location')]"
            },
            "sourceMapStorageAccount": {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('sourceMapStorageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "allowBlobPublicAccess": false,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              },
              "tags": "[parameters('tags')]"
            },
            "sourceMapContainer": {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/default/{1}', variables('sourceMapStorageAccountName'), parameters('sourceMapContainerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "sourceMapStorageAccount"
              ]
            },
            "appInsights": {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('{0}-applicationInsights', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-insightsWorkspace', parameters('namePrefix')))]"
              },
              "tags": "[union(parameters('tags'), createObject('hidden-link:Insights.Sourcemap.Storage', format('{{\"Uri\": \"{0}\"}}', variables('sourceMapUri'))))]",
              "dependsOn": [
                "appInsightsWorkspace"
              ]
            },
            "storageBlobDataContributorRoleDefinition": {
              "existing": true,
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2022-04-01",
              "subscriptionId": "[subscription().subscriptionId]",
              "name": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "metadata": {
                "description": "This is the built-in Storage Blob Data Contributor role. See https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage"
              }
            },
            "storageBlobDataReaderRoleDefinition": {
              "existing": true,
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2022-04-01",
              "subscriptionId": "[subscription().subscriptionId]",
              "name": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "metadata": {
                "description": "This is the built-in Storage Blob Data Reader role. See https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage"
              }
            },
            "sourceMapStorageBlobDataContributorRole": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('sourceMapStorageAccountName'))]",
              "name": "[guid(format('{0}-sourcemaps-storage', parameters('namePrefix')), deployer().objectId, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[deployer().objectId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "sourceMapStorageAccount"
              ]
            },
            "sourceMapStorageBlobDataReaderRole": {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('sourceMapStorageAccountName'))]",
              "name": "[guid(format('{0}-sourcemaps-reader', parameters('namePrefix')), parameters('sourceMapsReaderGroupObjectId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[parameters('sourceMapsReaderGroupObjectId')]",
                "principalType": "Group"
              },
              "dependsOn": [
                "sourceMapStorageAccount"
              ]
            }
          },
          "outputs": {
            "connectionString": {
              "type": "string",
              "value": "[reference('appInsights').ConnectionString]"
            },
            "appInsightsWorkspaceName": {
              "type": "string",
              "value": "[format('{0}-insightsWorkspace', parameters('namePrefix'))]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', format('{0}-applicationInsights', parameters('namePrefix')))]"
            },
            "sourceMapStorageAccountName": {
              "type": "string",
              "value": "[variables('sourceMapStorageAccountName')]"
            },
            "sourceMapContainerName": {
              "type": "string",
              "value": "[parameters('sourceMapContainerName')]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "bffAvailabilityTests": {
      "copy": {
        "name": "bffAvailabilityTests",
        "count": "[length(variables('availabilityTestHostNames'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('bffAvailabilityTest-{0}', replace(variables('availabilityTestHostNames')[copyIndex()].name, '.', '-'))]",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('BFF - {0} - {1}', parameters('environment'), variables('availabilityTestHostNames')[copyIndex()].name)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appInsightsId": {
            "value": "[reference('appInsights').outputs.appInsightsId.value]"
          },
          "url": {
            "value": "[format('https://{0}/api/health', variables('availabilityTestHostNames')[copyIndex()].name)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "4350710880485424207"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability test"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the Application Insights resource"
              }
            },
            "url": {
              "type": "string",
              "metadata": {
                "description": "The URL of the availability test"
              }
            },
            "frequency": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "The frequency in seconds at which the test runs"
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 60,
              "metadata": {
                "description": "The timeout in seconds for the test"
              }
            }
          },
          "resources": {
            "availabilityTest": {
              "type": "Microsoft.Insights/webtests",
              "apiVersion": "2022-06-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject(format('hidden-link:{0}', parameters('appInsightsId')), 'Resource'))]",
              "kind": "standard",
              "properties": {
                "Enabled": true,
                "SyntheticMonitorId": "[parameters('name')]",
                "Name": "[parameters('name')]",
                "Description": "[format('Availability test for {0}', parameters('name'))]",
                "Frequency": "[parameters('frequency')]",
                "Timeout": "[parameters('timeout')]",
                "Kind": "standard",
                "RetryEnabled": true,
                "Locations": [
                  {
                    "Id": "emea-nl-ams-azr"
                  },
                  {
                    "Id": "emea-se-sto-edge"
                  },
                  {
                    "Id": "emea-gb-db3-azr"
                  }
                ],
                "Request": {
                  "RequestUrl": "[parameters('url')]",
                  "HttpVerb": "GET",
                  "ParseDependentRequests": false
                },
                "ValidationRules": {
                  "ExpectedHttpStatusCode": 200,
                  "SSLCheck": true,
                  "SSLCertRemainingLifetimeCheck": 7
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "resourceGroup"
      ]
    },
    "frontendAvailabilityTests": {
      "copy": {
        "name": "frontendAvailabilityTests",
        "count": "[length(variables('availabilityTestHostNames'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('frontendAvailabilityTest-{0}', replace(variables('availabilityTestHostNames')[copyIndex()].name, '.', '-'))]",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('Frontend - {0} - {1}', parameters('environment'), variables('availabilityTestHostNames')[copyIndex()].name)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "appInsightsId": {
            "value": "[reference('appInsights').outputs.appInsightsId.value]"
          },
          "url": {
            "value": "[format('https://{0}', variables('availabilityTestHostNames')[copyIndex()].name)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "4350710880485424207"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability test"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the Application Insights resource"
              }
            },
            "url": {
              "type": "string",
              "metadata": {
                "description": "The URL of the availability test"
              }
            },
            "frequency": {
              "type": "int",
              "defaultValue": 120,
              "metadata": {
                "description": "The frequency in seconds at which the test runs"
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 60,
              "metadata": {
                "description": "The timeout in seconds for the test"
              }
            }
          },
          "resources": {
            "availabilityTest": {
              "type": "Microsoft.Insights/webtests",
              "apiVersion": "2022-06-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject(format('hidden-link:{0}', parameters('appInsightsId')), 'Resource'))]",
              "kind": "standard",
              "properties": {
                "Enabled": true,
                "SyntheticMonitorId": "[parameters('name')]",
                "Name": "[parameters('name')]",
                "Description": "[format('Availability test for {0}', parameters('name'))]",
                "Frequency": "[parameters('frequency')]",
                "Timeout": "[parameters('timeout')]",
                "Kind": "standard",
                "RetryEnabled": true,
                "Locations": [
                  {
                    "Id": "emea-nl-ams-azr"
                  },
                  {
                    "Id": "emea-se-sto-edge"
                  },
                  {
                    "Id": "emea-gb-db3-azr"
                  }
                ],
                "Request": {
                  "RequestUrl": "[parameters('url')]",
                  "HttpVerb": "GET",
                  "ParseDependentRequests": false
                },
                "ValidationRules": {
                  "ExpectedHttpStatusCode": 200,
                  "SSLCheck": true,
                  "SSLCertRemainingLifetimeCheck": 7
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "resourceGroup"
      ]
    },
    "appConfiguration": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appConfiguration",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "11628496513669996894"
            }
          },
          "definitions": {
            "Sku": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "Free",
                    "Standard"
                  ]
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix used for naming resources to ensure unique names"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "sku": {
              "$ref": "#/definitions/Sku",
              "defaultValue": {
                "name": "Standard"
              },
              "metadata": {
                "description": "The SKU of the App Configuration store"
              }
            },
            "disableLocalAuth": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to disable local authentication (use Entra ID only)"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 1,
              "maxValue": 7,
              "metadata": {
                "description": "Number of days to retain soft-deleted configuration stores"
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to enable purge protection"
              }
            }
          },
          "resources": {
            "appConfiguration": {
              "type": "Microsoft.AppConfiguration/configurationStores",
              "apiVersion": "2025-02-01-preview",
              "name": "[format('{0}-appConfiguration', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "sku": "[parameters('sku')]",
              "properties": {
                "disableLocalAuth": "[parameters('disableLocalAuth')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
                "dataPlaneProxy": {
                  "authenticationMode": "Local",
                  "privateLinkDelegation": "Disabled"
                }
              },
              "tags": "[parameters('tags')]"
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "value": "[format('{0}-appConfiguration', parameters('namePrefix'))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference('appConfiguration').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "containerAppEnv": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "containerAppEnv",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-containerappenv', variables('namePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightWorkspaceName": {
            "value": "[reference('appInsights').outputs.appInsightsWorkspaceName.value]"
          },
          "subnetId": {
            "value": "[reference('vnet').outputs.containerAppEnvironmentSubnetId.value]"
          },
          "zoneRedundancyEnabled": {
            "value": "[parameters('containerAppEnvZoneRedundancyEnabled')]"
          },
          "workloadProfiles": {
            "value": "[parameters('containerAppEnvWorkloadProfiles')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference('appInsights').outputs.connectionString.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "5615715637719899563"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The geographic location where the resource will be deployed"
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the container app environment"
              }
            },
            "subnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The identifier for the subnet where the container app environment will be deployed"
              }
            },
            "appInsightWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights workspace associated with the container app environment"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "The connection string for the Application Insights workspace associated with the container app environment"
              }
            },
            "zoneRedundancyEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to enable zone redundancy for the container app environment"
              }
            },
            "workloadProfiles": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The workload profiles for the container app environment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "resources": {
            "appInsightsWorkspace": {
              "existing": true,
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('appInsightWorkspaceName')]"
            },
            "containerAppEnv": {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-10-02-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "vnetConfiguration": "[if(not(empty(parameters('subnetId'))), createObject('infrastructureSubnetId', parameters('subnetId'), 'internal', true()), null())]",
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference('appInsightsWorkspace').customerId]",
                    "sharedKey": "[listKeys('appInsightsWorkspace', '2022-10-01').primarySharedKey]"
                  }
                },
                "appInsightsConfiguration": {
                  "connectionString": "[parameters('appInsightsConnectionString')]"
                },
                "openTelemetryConfiguration": {
                  "tracesConfiguration": {
                    "destinations": [
                      "appInsights"
                    ]
                  },
                  "logsConfiguration": {
                    "destinations": [
                      "appInsights"
                    ]
                  }
                },
                "zoneRedundant": "[parameters('zoneRedundancyEnabled')]",
                "availabilityZones": "[if(parameters('zoneRedundancyEnabled'), createArray('1', '2', '3'), null())]",
                "workloadProfiles": "[parameters('workloadProfiles')]"
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "appInsightsWorkspace"
              ]
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "defaultDomain": {
              "type": "string",
              "value": "[reference('containerAppEnv').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "value": "[reference('containerAppEnv').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "resourceGroup",
        "vnet"
      ]
    },
    "containerAppEnvPrivateDnsZone": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "containerAppEnvPrivateDnsZone",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "defaultDomain": {
            "value": "[reference('containerAppEnv').outputs.defaultDomain.value]"
          },
          "vnetId": {
            "value": "[reference('vnet').outputs.virtualNetworkId.value]"
          },
          "aRecords": {
            "value": [
              {
                "ip": "[reference('containerAppEnv').outputs.staticIp.value]",
                "name": "*",
                "ttl": 3600
              },
              {
                "ip": "[reference('containerAppEnv').outputs.staticIp.value]",
                "name": "@",
                "ttl": 3600
              }
            ]
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "9534921032175889237"
            }
          },
          "definitions": {
            "ARecord": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "ip": {
                  "type": "string"
                },
                "ttl": {
                  "type": "int"
                }
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix used for naming resources to ensure unique names"
              }
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "The default domain for the private DNS zone"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the virtual network linked to the private DNS zone"
              }
            },
            "aRecords": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/ARecord"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Array of A records to be created in the DNS zone"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "resources": {
            "privateDnsZone": {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[parameters('defaultDomain')]",
              "location": "global",
              "properties": {}
            },
            "aRecordResources": {
              "copy": {
                "name": "aRecordResources",
                "count": "[length(parameters('aRecords'))]"
              },
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), parameters('aRecords')[copyIndex()].name)]",
              "properties": {
                "ttl": "[parameters('aRecords')[copyIndex()].ttl]",
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('aRecords')[copyIndex()].ip]"
                  }
                ]
              },
              "dependsOn": [
                "privateDnsZone"
              ]
            },
            "virtualNetworkLink": {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), format('{0}-pdns-link', parameters('namePrefix')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "privateDnsZone"
              ]
            }
          },
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
            }
          }
        }
      },
      "dependsOn": [
        "containerAppEnv",
        "resourceGroup",
        "vnet"
      ]
    },
    "postgresqlPrivateDnsZone": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "postgresqlPrivateDnsZone",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "defaultDomain": {
            "value": "[format('{0}.postgres.database.azure.com', variables('namePrefix'))]"
          },
          "vnetId": {
            "value": "[reference('vnet').outputs.virtualNetworkId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "9534921032175889237"
            }
          },
          "definitions": {
            "ARecord": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "ip": {
                  "type": "string"
                },
                "ttl": {
                  "type": "int"
                }
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix used for naming resources to ensure unique names"
              }
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "The default domain for the private DNS zone"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the virtual network linked to the private DNS zone"
              }
            },
            "aRecords": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/ARecord"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Array of A records to be created in the DNS zone"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "resources": {
            "privateDnsZone": {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[parameters('defaultDomain')]",
              "location": "global",
              "properties": {}
            },
            "aRecordResources": {
              "copy": {
                "name": "aRecordResources",
                "count": "[length(parameters('aRecords'))]"
              },
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), parameters('aRecords')[copyIndex()].name)]",
              "properties": {
                "ttl": "[parameters('aRecords')[copyIndex()].ttl]",
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('aRecords')[copyIndex()].ip]"
                  }
                ]
              },
              "dependsOn": [
                "privateDnsZone"
              ]
            },
            "virtualNetworkLink": {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), format('{0}-pdns-link', parameters('namePrefix')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "privateDnsZone"
              ]
            }
          },
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup",
        "vnet"
      ]
    },
    "applicationGateway": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "applicationGateway",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppEnvName": {
            "value": "[reference('containerAppEnv').outputs.name.value]"
          },
          "subnetId": {
            "value": "[reference('vnet').outputs.applicationGatewaySubnetId.value]"
          },
          "configuration": {
            "value": "[parameters('applicationGatewayConfiguration')]"
          },
          "appInsightWorkspaceName": {
            "value": "[reference('appInsights').outputs.appInsightsWorkspaceName.value]"
          },
          "enableMaintenancePage": {
            "value": "[parameters('enableMaintenancePage')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "4084565153894604784"
            }
          },
          "definitions": {
            "HostNameConfiguration": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "sslCertificateSecretKey": {
                  "type": "string"
                },
                "redirectTo": {
                  "type": "string",
                  "nullable": true
                },
                "enableAvailabilityTest": {
                  "type": "bool"
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "Configuration": {
              "type": "object",
              "properties": {
                "sku": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string",
                      "allowedValues": [
                        "Standard_v2",
                        "WAF_v2"
                      ]
                    },
                    "tier": {
                      "type": "string",
                      "allowedValues": [
                        "Standard_v2",
                        "WAF_v2"
                      ]
                    },
                    "capacity": {
                      "type": "int",
                      "nullable": true
                    }
                  }
                },
                "autoscaleConfiguration": {
                  "type": "object",
                  "properties": {
                    "minCapacity": {
                      "type": "int"
                    },
                    "maxCapacity": {
                      "type": "int"
                    }
                  },
                  "nullable": true
                },
                "hostNames": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/HostNameConfiguration"
                  },
                  "minLength": 1,
                  "metadata": {
                    "description": "Array of hostnames. Exactly one must be marked as primary (isPrimary: true)."
                  }
                },
                "sslCertificateKeyVaultName": {
                  "type": "string"
                },
                "zones": {
                  "type": "array",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix used to name resources, ensuring unique names across the deployment."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The Azure region where resources will be deployed."
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The identifier of the subnet where the Application Gateway will be deployed."
              }
            },
            "containerAppEnvName": {
              "type": "string",
              "metadata": {
                "description": "The name of the existing container app environment to be used."
              }
            },
            "appInsightWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the existing log analytics workspace to be used."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            },
            "enableMaintenancePage": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable maintenance mode to redirect all traffic to maintenance page"
              }
            },
            "configuration": {
              "$ref": "#/definitions/Configuration",
              "metadata": {
                "description": "Configuration settings for the Application Gateway, including SKU, hostnames and autoscale parameters."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "allHostNames",
                "count": "[length(parameters('configuration').hostNames)]",
                "input": "[parameters('configuration').hostNames[copyIndex('allHostNames')].name]"
              },
              {
                "name": "invalidRedirectTargets",
                "count": "[length(variables('redirectingHostNames'))]",
                "input": "[and(not(equals(tryGet(variables('redirectingHostNames')[copyIndex('invalidRedirectTargets')], 'redirectTo'), null())), not(contains(variables('allHostNames'), variables('redirectingHostNames')[copyIndex('invalidRedirectTargets')].redirectTo)))]"
              },
              {
                "name": "selfRedirects",
                "count": "[length(variables('redirectingHostNames'))]",
                "input": "[equals(variables('redirectingHostNames')[copyIndex('selfRedirects')].name, tryGet(variables('redirectingHostNames')[copyIndex('selfRedirects')], 'redirectTo'))]"
              },
              {
                "name": "sslCertificateSecretIds",
                "count": "[length(parameters('configuration').hostNames)]",
                "input": {
                  "name": "[parameters('configuration').hostNames[copyIndex('sslCertificateSecretIds')].name]",
                  "secretId": "[format('https://{0}{1}/secrets/{2}', parameters('configuration').sslCertificateKeyVaultName, environment().suffixes.keyvaultDns, parameters('configuration').hostNames[copyIndex('sslCertificateSecretIds')].sslCertificateSecretKey)]"
                }
              },
              {
                "name": "httpsListeners",
                "count": "[length(parameters('configuration').hostNames)]",
                "input": {
                  "name": "[format('{0}-gatewayHttpListener-443-{1}', variables('gatewayName'), replace(parameters('configuration').hostNames[copyIndex('httpsListeners')].name, '.', '-'))]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('gatewayName'), format('{0}-gatewayFrontendIp', variables('gatewayName')))]"
                    },
                    "frontendPort": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('gatewayName'), format('{0}-gatewayFrontendPort-443', variables('gatewayName')))]"
                    },
                    "requireServerNameIndication": false,
                    "protocol": "Https",
                    "hostName": "[parameters('configuration').hostNames[copyIndex('httpsListeners')].name]",
                    "sslCertificate": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/sslCertificates', variables('gatewayName'), format('{0}-gatewaySslCertificate-{1}', variables('gatewayName'), replace(parameters('configuration').hostNames[copyIndex('httpsListeners')].name, '.', '-')))]"
                    }
                  }
                }
              },
              {
                "name": "hostnameRedirectConfigurations",
                "count": "[length(variables('redirectingHostNames'))]",
                "input": {
                  "name": "[take(format('{0}-redir-{1}', variables('gatewayName'), replace(variables('redirectingHostNames')[copyIndex('hostnameRedirectConfigurations')].name, '.', '-')), 80)]",
                  "properties": {
                    "redirectType": "Permanent",
                    "includePath": true,
                    "includeQueryString": true,
                    "targetUrl": "[format('https://{0}', tryGet(variables('redirectingHostNames')[copyIndex('hostnameRedirectConfigurations')], 'redirectTo'))]",
                    "requestRoutingRules": [
                      {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/requestRoutingRules', variables('gatewayName'), take(format('{0}-redir-{1}', variables('gatewayName'), replace(variables('redirectingHostNames')[copyIndex('hostnameRedirectConfigurations')].name, '.', '-')), 80))]"
                      }
                    ]
                  }
                }
              },
              {
                "name": "hostnameRedirectRoutingRules",
                "count": "[length(variables('redirectingHostNames'))]",
                "input": {
                  "name": "[take(format('{0}-redir-{1}', variables('gatewayName'), replace(variables('redirectingHostNames')[copyIndex('hostnameRedirectRoutingRules')].name, '.', '-')), 80)]",
                  "properties": {
                    "priority": "[add(200, copyIndex('hostnameRedirectRoutingRules'))]",
                    "ruleType": "Basic",
                    "redirectConfiguration": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/redirectConfigurations', variables('gatewayName'), take(format('{0}-redir-{1}', variables('gatewayName'), replace(variables('redirectingHostNames')[copyIndex('hostnameRedirectRoutingRules')].name, '.', '-')), 80))]"
                    },
                    "httpListener": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('gatewayName'), format('{0}-gatewayHttpListener-443-{1}', variables('gatewayName'), replace(variables('redirectingHostNames')[copyIndex('hostnameRedirectRoutingRules')].name, '.', '-')))]"
                    }
                  }
                }
              },
              {
                "name": "activeHostnameRoutingRules",
                "count": "[length(variables('activeHostNames'))]",
                "input": {
                  "name": "[take(format('{0}-route-{1}', variables('gatewayName'), replace(variables('activeHostNames')[copyIndex('activeHostnameRoutingRules')].name, '.', '-')), 80)]",
                  "properties": {
                    "priority": "[add(100, copyIndex('activeHostnameRoutingRules'))]",
                    "ruleType": "PathBasedRouting",
                    "httpListener": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('gatewayName'), format('{0}-gatewayHttpListener-443-{1}', variables('gatewayName'), replace(variables('activeHostNames')[copyIndex('activeHostnameRoutingRules')].name, '.', '-')))]"
                    },
                    "urlPathMap": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/urlPathMaps', variables('gatewayName'), variables('pathMapName'))]"
                    }
                  }
                }
              }
            ],
            "gatewayName": "[format('{0}-applicationGateway', parameters('namePrefix'))]",
            "activeHostNames": "[filter(parameters('configuration').hostNames, lambda('h', equals(tryGet(lambdaVariables('h'), 'redirectTo'), null())))]",
            "redirectingHostNames": "[filter(parameters('configuration').hostNames, lambda('h', not(equals(tryGet(lambdaVariables('h'), 'redirectTo'), null()))))]",
            "publicIpName": "[if(not(empty(tryGet(parameters('configuration'), 'zones'))), format('{0}-publicIp-zonal', variables('gatewayName')), format('{0}-publicIp', variables('gatewayName')))]",
            "publicIpAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
            "maintenanceHostName": "[format('dialogportentemp.z1.web.{0}', environment().suffixes.storage)]",
            "maintenancePool": {
              "name": "[format('{0}-maintenancePool', variables('gatewayName'))]",
              "properties": {
                "backendAddresses": [
                  {
                    "fqdn": "[variables('maintenanceHostName')]"
                  }
                ]
              }
            },
            "maintenanceProbe": {
              "name": "[format('{0}-maintenancePool-probe', variables('gatewayName'))]",
              "properties": {
                "host": "[variables('maintenanceHostName')]",
                "protocol": "Https",
                "path": "/",
                "interval": 30,
                "timeout": 30,
                "unhealthyThreshold": 3,
                "pickHostNameFromBackendSettings": false
              }
            },
            "maintenanceHttpSettings": {
              "name": "[format('{0}-maintenancePool-backendHttpSettings', variables('gatewayName'))]",
              "properties": {
                "port": 443,
                "protocol": "Https",
                "cookieBasedAffinity": "Disabled",
                "pickHostNameFromBackendAddress": false,
                "hostName": "[variables('maintenanceHostName')]",
                "requestTimeout": 60,
                "probe": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), variables('maintenanceProbe').name)]"
                }
              }
            },
            "maintenanceGatewayBackend": {
              "pool": "[variables('maintenancePool')]",
              "httpSettings": "[variables('maintenanceHttpSettings')]",
              "probe": "[variables('maintenanceProbe')]"
            },
            "httpListener": {
              "name": "[format('{0}-gatewayHttpListener-80', variables('gatewayName'))]",
              "properties": {
                "frontendIPConfiguration": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('gatewayName'), format('{0}-gatewayFrontendIp', variables('gatewayName')))]"
                },
                "frontendPort": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('gatewayName'), format('{0}-gatewayFrontendPort-80', variables('gatewayName')))]"
                },
                "requireServerNameIndication": false,
                "protocol": "Http"
              }
            },
            "httpToHttpsRedirectConfiguration": {
              "name": "[format('{0}-http-to-https', variables('gatewayName'))]",
              "properties": {
                "redirectType": "Permanent",
                "includePath": true,
                "includeQueryString": true,
                "targetListener": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('gatewayName'), format('{0}-gatewayHttpListener-443-{1}', variables('gatewayName'), replace(variables('activeHostNames')[0].name, '.', '-')))]"
                },
                "requestRoutingRules": [
                  {
                    "id": "[resourceId('Microsoft.Network/applicationGateways/requestRoutingRules', variables('gatewayName'), format('{0}-http-to-https', variables('gatewayName')))]"
                  }
                ]
              }
            },
            "pathMapName": "[format('{0}-bffBackendPool.pathMap', variables('gatewayName'))]",
            "httpToHttpsRoutingRule": {
              "name": "[format('{0}-http-to-https', variables('gatewayName'))]",
              "properties": {
                "priority": 300,
                "ruleType": "Basic",
                "redirectConfiguration": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/redirectConfigurations', variables('gatewayName'), format('{0}-http-to-https', variables('gatewayName')))]"
                },
                "httpListener": {
                  "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('gatewayName'), format('{0}-gatewayHttpListener-80', variables('gatewayName')))]"
                }
              }
            },
            "diagnosticSettingRetentionPolicy": {
              "days": 0,
              "enabled": false
            },
            "diagnosticLogCategories": [
              "ApplicationGatewayAccessLog",
              "ApplicationGatewayPerformanceLog"
            ]
          },
          "resources": {
            "containerAppEnvironment": {
              "existing": true,
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('containerAppEnvName')]"
            },
            "appInsightsWorkspace": {
              "existing": true,
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('appInsightWorkspaceName')]"
            },
            "publicIp": {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2021-03-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
              },
              "zones": "[tryGet(parameters('configuration'), 'zones')]",
              "tags": "[parameters('tags')]"
            },
            "applicationGatewayAssignedIdentity": {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}-identity', variables('gatewayName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            "applicationGateway": {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2024-01-01",
              "name": "[variables('gatewayName')]",
              "location": "[parameters('location')]",
              "zones": "[tryGet(parameters('configuration'), 'zones')]",
              "properties": {
                "copy": [
                  {
                    "name": "sslCertificates",
                    "count": "[length(parameters('configuration').hostNames)]",
                    "input": {
                      "name": "[format('{0}-gatewaySslCertificate-{1}', variables('gatewayName'), replace(parameters('configuration').hostNames[copyIndex('sslCertificates')].name, '.', '-'))]",
                      "properties": {
                        "keyVaultSecretId": "[filter(variables('sslCertificateSecretIds'), lambda('cert', equals(lambdaVariables('cert').name, parameters('configuration').hostNames[copyIndex('sslCertificates')].name)))[0].secretId]"
                      }
                    }
                  }
                ],
                "autoscaleConfiguration": "[tryGet(parameters('configuration'), 'autoscaleConfiguration')]",
                "enableHttp2": true,
                "sku": "[parameters('configuration').sku]",
                "gatewayIPConfigurations": [
                  {
                    "name": "[format('{0}-gatewayIpConfig', variables('gatewayName'))]",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      }
                    }
                  }
                ],
                "privateLinkConfigurations": [
                  {
                    "name": "[format('{0}-plc', variables('gatewayName'))]",
                    "properties": {
                      "ipConfigurations": [
                        {
                          "name": "default",
                          "properties": {
                            "primary": true,
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                              "id": "[parameters('subnetId')]"
                            }
                          }
                        }
                      ]
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "[format('{0}-gatewayFrontendIp', variables('gatewayName'))]",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[variables('publicIpAddressId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "privateLinkConfiguration": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/privateLinkConfigurations', variables('gatewayName'), format('{0}-plc', variables('gatewayName')))]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "[format('{0}-gatewayFrontendPort-443', variables('gatewayName'))]",
                    "properties": {
                      "port": 443
                    }
                  },
                  {
                    "name": "[format('{0}-gatewayFrontendPort-80', variables('gatewayName'))]",
                    "properties": {
                      "port": 80
                    }
                  }
                ],
                "httpListeners": "[concat(variables('httpsListeners'), createArray(variables('httpListener')))]",
                "redirectConfigurations": "[concat(createArray(variables('httpToHttpsRedirectConfiguration')), variables('hostnameRedirectConfigurations'))]",
                "backendAddressPools": [
                  "[createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool]",
                  "[createObject('pool', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-frontendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 60, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool]",
                  "[variables('maintenanceGatewayBackend').pool]"
                ],
                "backendHttpSettingsCollection": [
                  "[createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).httpSettings]",
                  "[createObject('pool', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-frontendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 60, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).httpSettings]",
                  "[variables('maintenanceGatewayBackend').httpSettings]"
                ],
                "probes": [
                  "[createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).probe]",
                  "[createObject('pool', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-frontendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 60, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).probe]",
                  "[variables('maintenanceGatewayBackend').probe]"
                ],
                "urlPathMaps": [
                  {
                    "name": "[format('{0}.pathMap', createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool.name)]",
                    "properties": {
                      "defaultBackendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('gatewayName'), if(parameters('enableMaintenancePage'), variables('maintenanceGatewayBackend').pool.name, createObject('pool', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-frontendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 60, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool.name))]"
                      },
                      "defaultBackendHttpSettings": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('gatewayName'), if(parameters('enableMaintenancePage'), variables('maintenanceGatewayBackend').httpSettings.name, createObject('pool', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-frontendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 60, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-frontendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-frontendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-frontend.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).httpSettings.name))]"
                      },
                      "pathRules": "[if(parameters('enableMaintenancePage'), createArray(), createArray(createObject('name', createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool.name, 'properties', createObject('paths', createArray('/api*'), 'backendAddressPool', createObject('id', resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('gatewayName'), createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).pool.name)), 'backendHttpSettings', createObject('id', resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('gatewayName'), createObject('pool', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))), 'httpSettings', createObject('name', format('{0}-bffBackendPool-backendHttpSettings', variables('gatewayName')), 'properties', createObject('port', 443, 'protocol', 'Https', 'cookieBasedAffinity', 'Disabled', 'pickHostNameFromBackendAddress', false(), 'hostName', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'requestTimeout', 120, 'probe', createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', variables('gatewayName'), createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false())).name)))), 'probe', createObject('name', format('{0}-bffBackendPool-probe', variables('gatewayName')), 'properties', createObject('host', createObject('name', format('{0}-bffBackendPool', variables('gatewayName')), 'properties', createObject('backendAddresses', createArray(createObject('fqdn', format('{0}-bff.{1}', parameters('namePrefix'), reference('containerAppEnvironment').defaultDomain))))).properties.backendAddresses[0].fqdn, 'protocol', 'Https', 'path', '/api/liveness', 'interval', 30, 'timeout', 30, 'unhealthyThreshold', 3, 'pickHostNameFromBackendSettings', false()))).httpSettings.name))))))]"
                    }
                  }
                ],
                "requestRoutingRules": "[concat(variables('activeHostnameRoutingRules'), variables('hostnameRedirectRoutingRules'), createArray(variables('httpToHttpsRoutingRule')))]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-identity', variables('gatewayName'))))]": {}
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "applicationGatewayAssignedIdentity",
                "containerAppEnvironment",
                "publicIp"
              ]
            },
            "diagnosticSetting": {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Network/applicationGateways/{0}', variables('gatewayName'))]",
              "name": "ApplicationGatewayDiagnosticSetting",
              "properties": {
                "copy": [
                  {
                    "name": "logs",
                    "count": "[length(variables('diagnosticLogCategories'))]",
                    "input": {
                      "category": "[variables('diagnosticLogCategories')[copyIndex('logs')]]",
                      "enabled": true,
                      "retentionPolicy": "[variables('diagnosticSettingRetentionPolicy')]"
                    }
                  }
                ],
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('appInsightWorkspaceName'))]"
              },
              "dependsOn": [
                "applicationGateway"
              ]
            }
          },
          "outputs": {
            "applicationGatewayId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/applicationGateways', variables('gatewayName'))]"
            }
          },
          "asserts": {
            "hasActiveHostname": "[greaterOrEquals(length(variables('activeHostNames')), 1)]",
            "validRedirectTargets": "[equals(length(filter(variables('invalidRedirectTargets'), lambda('invalid', lambdaVariables('invalid')))), 0)]",
            "noSelfRedirects": "[equals(length(filter(variables('selfRedirects'), lambda('isSelf', lambdaVariables('isSelf')))), 0)]"
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "containerAppEnv",
        "resourceGroup",
        "vnet"
      ]
    },
    "redis": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "redis",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentKeyVaultName": {
            "value": "[reference('environmentKeyVault').outputs.name.value]"
          },
          "version": {
            "value": "[parameters('redisVersion')]"
          },
          "sku": {
            "value": "[parameters('redisSku')]"
          },
          "subnetId": {
            "value": "[reference('vnet').outputs.redisSubnetId.value]"
          },
          "vnetId": {
            "value": "[reference('vnet').outputs.virtualNetworkId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "7966734752426243936"
            }
          },
          "definitions": {
            "Sku": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "Basic",
                    "Premium",
                    "Standard"
                  ]
                },
                "family": {
                  "type": "string",
                  "allowedValues": [
                    "C",
                    "P"
                  ]
                },
                "capacity": {
                  "type": "int",
                  "minValue": 1
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "subnetId": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "environmentKeyVaultName": {
              "type": "string",
              "minLength": 1
            },
            "version": {
              "type": "string",
              "minLength": 1
            },
            "sku": {
              "$ref": "#/definitions/Sku"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "resources": {
            "redis": {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}-redis', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "sku": "[parameters('sku')]",
                "enableNonSslPort": false,
                "redisConfiguration": {
                  "aad-enabled": "true",
                  "maxmemory-policy": "allkeys-lru"
                },
                "redisVersion": "[parameters('version')]",
                "publicNetworkAccess": "Disabled"
              },
              "tags": "[parameters('tags')]"
            },
            "redisPrivateEndpoint": {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}-redis-pe', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-redis-pe', parameters('namePrefix'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Cache/redis', format('{0}-redis', parameters('namePrefix')))]",
                      "groupIds": [
                        "redisCache"
                      ]
                    }
                  }
                ],
                "customNetworkInterfaceName": "[format('{0}-redis-pe-nic', parameters('namePrefix'))]",
                "subnet": {
                  "id": "[parameters('subnetId')]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "redis"
              ]
            },
            "privateDnsZone": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-redis-pdz', parameters('namePrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "namePrefix": {
                    "value": "[parameters('namePrefix')]"
                  },
                  "defaultDomain": {
                    "value": "privatelink.redis.cache.windows.net"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "9534921032175889237"
                    }
                  },
                  "definitions": {
                    "ARecord": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "ip": {
                          "type": "string"
                        },
                        "ttl": {
                          "type": "int"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "namePrefix": {
                      "type": "string",
                      "metadata": {
                        "description": "Prefix used for naming resources to ensure unique names"
                      }
                    },
                    "defaultDomain": {
                      "type": "string",
                      "metadata": {
                        "description": "The default domain for the private DNS zone"
                      }
                    },
                    "vnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the virtual network linked to the private DNS zone"
                      }
                    },
                    "aRecords": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/ARecord"
                      },
                      "defaultValue": [],
                      "metadata": {
                        "description": "Array of A records to be created in the DNS zone"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    }
                  },
                  "resources": {
                    "privateDnsZone": {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('defaultDomain')]",
                      "location": "global",
                      "properties": {}
                    },
                    "aRecordResources": {
                      "copy": {
                        "name": "aRecordResources",
                        "count": "[length(parameters('aRecords'))]"
                      },
                      "type": "Microsoft.Network/privateDnsZones/A",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('defaultDomain'), parameters('aRecords')[copyIndex()].name)]",
                      "properties": {
                        "ttl": "[parameters('aRecords')[copyIndex()].ttl]",
                        "aRecords": [
                          {
                            "ipv4Address": "[parameters('aRecords')[copyIndex()].ip]"
                          }
                        ]
                      },
                      "dependsOn": [
                        "privateDnsZone"
                      ]
                    },
                    "virtualNetworkLink": {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/{1}', parameters('defaultDomain'), format('{0}-pdns-link', parameters('namePrefix')))]",
                      "location": "global",
                      "properties": {
                        "registrationEnabled": false,
                        "virtualNetwork": {
                          "id": "[parameters('vnetId')]"
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "privateDnsZone"
                      ]
                    }
                  },
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
                    }
                  }
                }
              }
            },
            "privateDnsZoneGroup": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-redis-privateDnsZoneGroup', parameters('namePrefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "default"
                  },
                  "dnsZoneGroupName": {
                    "value": "privatelink-redis-cache-windows-net"
                  },
                  "dnsZoneId": {
                    "value": "[reference('privateDnsZone').outputs.id.value]"
                  },
                  "privateEndpointName": {
                    "value": "[format('{0}-redis-pe', parameters('namePrefix'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "13437432027890231063"
                    }
                  },
                  "parameters": {
                    "dnsZoneId": {
                      "type": "string"
                    },
                    "privateEndpointName": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "dnsZoneGroupName": {
                      "type": "string"
                    }
                  },
                  "resources": {
                    "privateEndpoint": {
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[parameters('privateEndpointName')]"
                    },
                    "pe_dns_zone_group": {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[parameters('dnsZoneGroupName')]",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "privateDnsZone",
                "redisPrivateEndpoint"
              ]
            },
            "redisConnectionString": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "redisConnectionString",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "destKeyVaultName": {
                    "value": "[parameters('environmentKeyVaultName')]"
                  },
                  "secretName": {
                    "value": "redisConnectionString"
                  },
                  "secretValue": {
                    "value": "[format('rediss://:{0}@{1}:{2}', reference('redis').accessKeys.primaryKey, reference('redis').hostName, reference('redis').sslPort)]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "3841694917037618761"
                    }
                  },
                  "parameters": {
                    "destKeyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    }
                  },
                  "resources": {
                    "secret": {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('destKeyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  },
                  "outputs": {
                    "secretUri": {
                      "type": "string",
                      "value": "[reference('secret').secretUri]"
                    }
                  }
                }
              },
              "dependsOn": [
                "redis"
              ]
            }
          },
          "outputs": {
            "connectionStringSecretUri": {
              "type": "string",
              "value": "[reference('redisConnectionString').outputs.secretUri.value]"
            }
          }
        }
      },
      "dependsOn": [
        "environmentKeyVault",
        "resourceGroup",
        "vnet"
      ]
    },
    "postgresql": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "postgresql",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "subnetId": {
            "value": "[reference('vnet').outputs.postgresqlSubnetId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "keyVaultName": {
            "value": "[reference('environmentKeyVault').outputs.name.value]"
          },
          "srcKeyVault": {
            "value": "[variables('srcKeyVault')]"
          },
          "srcSecretName": {
            "value": "[format('dialogportenPgAdminPassword{0}', parameters('environment'))]"
          },
          "administratorLoginPassword": "[if(contains(parameters('keyVaultSourceKeys'), format('dialogportenPgAdminPassword{0}', parameters('environment'))), createObject('reference', createObject('keyVault', createObject('id', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('secrets').sourceKeyVaultSubscriptionId, variables('secrets').sourceKeyVaultResourceGroup), 'Microsoft.KeyVault/vaults', variables('secrets').sourceKeyVaultName)), 'secretName', format('dialogportenPgAdminPassword{0}', parameters('environment')))), createObject('value', variables('secrets').dialogportenPgAdminPassword))]",
          "privateDnsZoneArmResourceId": {
            "value": "[reference('postgresqlPrivateDnsZone').outputs.id.value]"
          },
          "sku": {
            "value": "[parameters('postgresConfiguration').sku]"
          },
          "storage": {
            "value": "[parameters('postgresConfiguration').storage]"
          },
          "highAvailability": {
            "value": "[tryGet(parameters('postgresConfiguration'), 'highAvailability')]"
          },
          "availabilityZone": {
            "value": "[parameters('postgresConfiguration').availabilityZone]"
          },
          "backupRetentionDays": {
            "value": "[parameters('postgresConfiguration').backupRetentionDays]"
          },
          "postgresVersion": {
            "value": "[parameters('postgresConfiguration').version]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "enableBackupVault": {
            "value": "[parameters('enableBackupVault')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "8667318737257115857"
            }
          },
          "definitions": {
            "Sku": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "Standard_B12ms",
                    "Standard_B16ms",
                    "Standard_B1ms",
                    "Standard_B20ms",
                    "Standard_B2s",
                    "Standard_B4ms",
                    "Standard_B8ms",
                    "Standard_D2ads_v5",
                    "Standard_D4ads_v5",
                    "Standard_D8ads_v5"
                  ]
                },
                "tier": {
                  "type": "string",
                  "allowedValues": [
                    "Burstable",
                    "GeneralPurpose",
                    "MemoryOptimized"
                  ]
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "StorageConfiguration": {
              "type": "object",
              "properties": {
                "storageSizeGB": {
                  "type": "int",
                  "minValue": 32
                },
                "autoGrow": {
                  "type": "string",
                  "allowedValues": [
                    "Disabled",
                    "Enabled"
                  ]
                },
                "type": {
                  "type": "string",
                  "allowedValues": [
                    "PremiumV2_LRS",
                    "Premium_LRS"
                  ],
                  "metadata": {
                    "description": "The type of storage account to use. Default is Premium_LRS."
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "HighAvailabilityConfiguration": {
              "type": "object",
              "properties": {
                "mode": {
                  "type": "string",
                  "allowedValues": [
                    "Disabled",
                    "SameZone",
                    "ZoneRedundant"
                  ]
                },
                "standbyAvailabilityZone": {
                  "type": "string",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix used for naming resources to ensure unique names"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the resources will be deployed"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the environment Key Vault"
              }
            },
            "srcSecretName": {
              "type": "string",
              "metadata": {
                "description": "The name of the secret name(key) in the source key vault to store the PostgreSQL administrator login password"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the subnet where the PostgreSQL server will be deployed"
              }
            },
            "privateDnsZoneArmResourceId": {
              "type": "string",
              "metadata": {
                "description": "The ARM resource ID of the private DNS zone"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "enableBackupVault": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to provision a storage account + container for PostgreSQL restore backups"
              }
            },
            "backupVaultNamePrefix": {
              "type": "string",
              "defaultValue": "dp-be-prod-vault-backup",
              "metadata": {
                "description": "Name prefix for the backup vault storage account name generation (will be sanitized for storage account constraints)"
              }
            },
            "backupVaultContainerName": {
              "type": "string",
              "defaultValue": "dp-be-prod-postgresql-restore",
              "metadata": {
                "description": "Blob container name for PostgreSQL restore backups"
              }
            },
            "sku": {
              "$ref": "#/definitions/Sku",
              "metadata": {
                "description": "The SKU of the PostgreSQL server"
              }
            },
            "storage": {
              "$ref": "#/definitions/StorageConfiguration",
              "metadata": {
                "description": "The storage configuration for the PostgreSQL server"
              }
            },
            "highAvailability": {
              "$ref": "#/definitions/HighAvailabilityConfiguration",
              "nullable": true,
              "metadata": {
                "description": "High availability configuration for the PostgreSQL server"
              }
            },
            "availabilityZone": {
              "type": "string",
              "metadata": {
                "description": "The availability zone for the PostgreSQL primary server"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "minValue": 7,
              "maxValue": 35,
              "metadata": {
                "description": "The number of days to retain backups."
              }
            },
            "srcKeyVault": {
              "type": "secureObject",
              "metadata": {
                "description": "The Key Vault to store the PostgreSQL administrator login password"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "The password for the PostgreSQL administrator login"
              }
            },
            "postgresVersion": {
              "type": "string",
              "defaultValue": "15",
              "metadata": {
                "description": "PostgreSQL version"
              }
            }
          },
          "variables": {
            "administratorLogin": "dialogportenPgAdmin",
            "databaseName": "dialogporten",
            "backupVaultStorageAccountNamePrefix": "[toLower(replace(parameters('backupVaultNamePrefix'), '-', ''))]",
            "secretName": "databaseConnectionString"
          },
          "resources": {
            "postgres::database": {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2024-08-01",
              "name": "[format('{0}/{1}', format('{0}-postgres', parameters('namePrefix')), variables('databaseName'))]",
              "dependsOn": [
                "postgres"
              ]
            },
            "postgres": {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2024-08-01",
              "name": "[format('{0}-postgres', parameters('namePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "version": "[parameters('postgresVersion')]",
                "administratorLogin": "[variables('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "storage": {
                  "storageSizeGB": "[parameters('storage').storageSizeGB]",
                  "autoGrow": "[parameters('storage').autoGrow]",
                  "type": "[parameters('storage').type]"
                },
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "Disabled"
                },
                "dataEncryption": {
                  "type": "SystemManaged"
                },
                "replicationRole": "Primary",
                "network": {
                  "delegatedSubnetResourceId": "[parameters('subnetId')]",
                  "privateDnsZoneArmResourceId": "[parameters('privateDnsZoneArmResourceId')]"
                },
                "availabilityZone": "[parameters('availabilityZone')]",
                "highAvailability": "[parameters('highAvailability')]"
              },
              "sku": "[parameters('sku')]",
              "tags": "[parameters('tags')]"
            },
            "saveAdmPassword": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('Save_{0}', parameters('srcSecretName'))]",
              "subscriptionId": "[parameters('srcKeyVault').subscriptionId]",
              "resourceGroup": "[parameters('srcKeyVault').resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "destKeyVaultName": {
                    "value": "[parameters('srcKeyVault').name]"
                  },
                  "secretName": {
                    "value": "[parameters('srcSecretName')]"
                  },
                  "secretValue": {
                    "value": "[parameters('administratorLoginPassword')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "3841694917037618761"
                    }
                  },
                  "parameters": {
                    "destKeyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    }
                  },
                  "resources": {
                    "secret": {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('destKeyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  },
                  "outputs": {
                    "secretUri": {
                      "type": "string",
                      "value": "[reference('secret').secretUri]"
                    }
                  }
                }
              }
            },
            "backupVaultStorageAccount": {
              "condition": "[parameters('enableBackupVault')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "backupVaultStorageAccount",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "namePrefix": {
                    "value": "[variables('backupVaultStorageAccountNamePrefix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "allowBlobPublicAccess": {
                    "value": false
                  },
                  "enableHierarchicalNamespace": {
                    "value": false
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "4784472064831476858"
                    }
                  },
                  "parameters": {
                    "namePrefix": {
                      "type": "string",
                      "metadata": {
                        "description": "The prefix used for naming resources to ensure unique names"
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "The location where the resources will be deployed"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    },
                    "allowBlobPublicAccess": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Whether to enable blob public access"
                      }
                    },
                    "enableHierarchicalNamespace": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Whether to enable hierarchical namespace (Data Lake Storage Gen2)"
                      }
                    }
                  },
                  "variables": {
                    "storageAccountName": "[take(format('{0}storage{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)), 24)]"
                  },
                  "resources": {
                    "storageAccount": {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2025-01-01",
                      "name": "[variables('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard_LRS"
                      },
                      "kind": "StorageV2",
                      "properties": {
                        "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                        "isHnsEnabled": "[parameters('enableHierarchicalNamespace')]",
                        "requireInfrastructureEncryption": true,
                        "allowSharedKeyAccess": false,
                        "minimumTlsVersion": "TLS1_2",
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "blob": {
                              "enabled": true
                            },
                            "file": {
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        }
                      },
                      "tags": "[parameters('tags')]"
                    }
                  },
                  "outputs": {
                    "storageAccountName": {
                      "type": "string",
                      "value": "[variables('storageAccountName')]"
                    },
                    "storageAccountId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            "backupVaultStorageContainer": {
              "condition": "[parameters('enableBackupVault')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "backupVaultStorageContainer",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[coalesce(tryGet(if(parameters('enableBackupVault'), reference('backupVaultStorageAccount'), null()), 'outputs', 'storageAccountName', 'value'), '')]"
                  },
                  "containerName": {
                    "value": "[parameters('backupVaultContainerName')]"
                  },
                  "publicAccess": {
                    "value": "None"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "11275284486976831531"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the storage account to create the container in"
                      }
                    },
                    "containerName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the blob container"
                      }
                    },
                    "publicAccess": {
                      "type": "string",
                      "defaultValue": "None",
                      "allowedValues": [
                        "None",
                        "Blob",
                        "Container"
                      ],
                      "metadata": {
                        "description": "Public access level for the container"
                      }
                    }
                  },
                  "resources": {
                    "container": {
                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('containerName'))]",
                      "properties": {
                        "publicAccess": "[parameters('publicAccess')]"
                      }
                    }
                  },
                  "outputs": {
                    "containerId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', split(format('{0}/default/{1}', parameters('storageAccountName'), parameters('containerName')), '/')[0], split(format('{0}/default/{1}', parameters('storageAccountName'), parameters('containerName')), '/')[1], split(format('{0}/default/{1}', parameters('storageAccountName'), parameters('containerName')), '/')[2])]"
                    },
                    "containerName": {
                      "type": "string",
                      "value": "[parameters('containerName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "backupVaultStorageAccount"
              ]
            },
            "psqlConnectionObject": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[variables('secretName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "destKeyVaultName": {
                    "value": "[parameters('keyVaultName')]"
                  },
                  "secretName": {
                    "value": "[variables('secretName')]"
                  },
                  "secretValue": {
                    "value": "[format('postgres://{0}:{1}@{2}:5432/{3}?ssl=true', variables('administratorLogin'), parameters('administratorLoginPassword'), reference('postgres').fullyQualifiedDomainName, variables('databaseName'))]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "3841694917037618761"
                    }
                  },
                  "parameters": {
                    "destKeyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    }
                  },
                  "resources": {
                    "secret": {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('destKeyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  },
                  "outputs": {
                    "secretUri": {
                      "type": "string",
                      "value": "[reference('secret').secretUri]"
                    }
                  }
                }
              },
              "dependsOn": [
                "postgres"
              ]
            }
          },
          "outputs": {
            "serverName": {
              "type": "string",
              "value": "[format('{0}-postgres', parameters('namePrefix'))]"
            },
            "connectionStringSecretUri": {
              "type": "string",
              "value": "[reference('psqlConnectionObject').outputs.secretUri.value]"
            },
            "backupVaultStorageAccountName": {
              "type": "string",
              "value": "[coalesce(tryGet(if(parameters('enableBackupVault'), reference('backupVaultStorageAccount'), null()), 'outputs', 'storageAccountName', 'value'), '')]"
            },
            "backupVaultContainerName": {
              "type": "string",
              "value": "[if(parameters('enableBackupVault'), parameters('backupVaultContainerName'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "environmentKeyVault",
        "postgresqlPrivateDnsZone",
        "resourceGroup",
        "vnet"
      ]
    },
    "sshJumper": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sshJumper",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namePrefix": {
            "value": "[variables('namePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetId": {
            "value": "[reference('vnet').outputs.sshJumperSubnetId.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sshPublicKey": {
            "value": "[variables('secrets').sourceKeyVaultSshJumperSshPublicKey]"
          },
          "adminLoginGroupObjectId": {
            "value": "[parameters('entraDevelopersGroupId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "13800182141987464621"
            }
          },
          "parameters": {
            "namePrefix": {
              "type": "string",
              "metadata": {
                "description": "The name prefix to be used for the resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location to deploy the resource to"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet to deploy the network interface to"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to be applied to the resource"
              }
            },
            "sshPublicKey": {
              "type": "securestring",
              "metadata": {
                "description": "The SSH public key to be used for the virtual machine"
              }
            },
            "adminLoginGroupObjectId": {
              "type": "string",
              "metadata": {
                "description": "The object ID of the group to assign the Admin Login role for SSH Jumper"
              }
            }
          },
          "variables": {
            "name": "[format('{0}-ssh-jumper', parameters('namePrefix'))]"
          },
          "resources": {
            "publicIp": {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-ip', variables('name'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "1"
              ],
              "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
              },
              "tags": "[parameters('tags')]"
            },
            "networkInterface": {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2024-01-01",
              "name": "[variables('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "[format('{0}-ipconfig', variables('name'))]",
                    "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
                    "properties": {
                      "privateIPAddress": "10.0.0.4",
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-ip', variables('name')))]",
                        "properties": {
                          "deleteOption": "Delete"
                        }
                      },
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "primary": true,
                      "privateIPAddressVersion": "IPv4"
                    }
                  }
                ],
                "dnsSettings": {
                  "dnsServers": []
                },
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "disableTcpStateTracking": false,
                "nicType": "Standard",
                "auxiliaryMode": "None",
                "auxiliarySku": "None"
              },
              "dependsOn": [
                "publicIp"
              ]
            },
            "virtualMachine": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[variables('name')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[variables('name')]"
                  },
                  "sshPublicKey": {
                    "value": "[parameters('sshPublicKey')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "adminLoginGroupObjectId": {
                    "value": "[parameters('adminLoginGroupObjectId')]"
                  },
                  "enableJit": {
                    "value": true
                  },
                  "hardwareProfile": {
                    "value": {
                      "vmSize": "Standard_B1s"
                    }
                  },
                  "additionalCapabilities": {
                    "value": {
                      "hibernationEnabled": false
                    }
                  },
                  "storageProfile": {
                    "value": {
                      "imageReference": {
                        "publisher": "Canonical",
                        "offer": "0001-com-ubuntu-server-jammy",
                        "sku": "22_04-lts-gen2",
                        "version": "latest"
                      },
                      "osDisk": {
                        "osType": "Linux",
                        "name": "[format('{0}-osdisk', variables('name'))]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                          "storageAccountType": "Premium_LRS"
                        },
                        "deleteOption": "Delete",
                        "diskSizeGB": 30
                      },
                      "dataDisks": [],
                      "diskControllerType": "SCSI"
                    }
                  },
                  "securityProfile": {
                    "value": {
                      "uefiSettings": {
                        "secureBootEnabled": true,
                        "vTpmEnabled": true
                      },
                      "securityType": "TrustedLaunch",
                      "encryptionAtHost": true
                    }
                  },
                  "networkProfile": {
                    "value": {
                      "networkInterfaces": [
                        {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('name'))]",
                          "properties": {
                            "deleteOption": "Delete"
                          }
                        }
                      ]
                    }
                  },
                  "diagnosticsProfile": {
                    "value": {
                      "bootDiagnostics": {
                        "enabled": true
                      }
                    }
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "12294967417484014044"
                    }
                  },
                  "definitions": {
                    "HardwareProfile": {
                      "type": "object",
                      "properties": {
                        "vmSize": {
                          "type": "string"
                        }
                      }
                    },
                    "AdditionalCapabilities": {
                      "type": "object",
                      "properties": {
                        "hibernationEnabled": {
                          "type": "bool"
                        }
                      }
                    },
                    "SecurityProfile": {
                      "type": "object",
                      "properties": {
                        "uefiSettings": {
                          "type": "object",
                          "properties": {
                            "secureBootEnabled": {
                              "type": "bool"
                            },
                            "vTpmEnabled": {
                              "type": "bool"
                            }
                          }
                        },
                        "securityType": {
                          "type": "string"
                        },
                        "encryptionAtHost": {
                          "type": "bool"
                        }
                      }
                    },
                    "NetworkInterface": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "properties": {
                          "type": "object",
                          "properties": {
                            "deleteOption": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    },
                    "NetworkProfile": {
                      "type": "object",
                      "properties": {
                        "networkInterfaces": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/NetworkInterface"
                          }
                        }
                      }
                    },
                    "DiagnosticsProfile": {
                      "type": "object",
                      "properties": {
                        "bootDiagnostics": {
                          "type": "object",
                          "properties": {
                            "enabled": {
                              "type": "bool"
                            }
                          }
                        }
                      }
                    },
                    "StorageProfile": {
                      "type": "object",
                      "properties": {
                        "imageReference": {
                          "type": "object",
                          "properties": {
                            "publisher": {
                              "type": "string"
                            },
                            "offer": {
                              "type": "string"
                            },
                            "sku": {
                              "type": "string"
                            },
                            "version": {
                              "type": "string"
                            }
                          }
                        },
                        "osDisk": {
                          "type": "object",
                          "properties": {
                            "osType": {
                              "type": "string",
                              "allowedValues": [
                                "Linux",
                                "Windows"
                              ],
                              "nullable": true
                            },
                            "name": {
                              "type": "string"
                            },
                            "createOption": {
                              "type": "string"
                            },
                            "caching": {
                              "type": "string",
                              "allowedValues": [
                                "None",
                                "ReadOnly",
                                "ReadWrite"
                              ],
                              "nullable": true
                            },
                            "managedDisk": {
                              "type": "object",
                              "properties": {
                                "storageAccountType": {
                                  "type": "string"
                                }
                              }
                            },
                            "deleteOption": {
                              "type": "string"
                            },
                            "diskSizeGB": {
                              "type": "int"
                            }
                          }
                        },
                        "dataDisks": {
                          "type": "array"
                        },
                        "diskControllerType": {
                          "type": "string"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "hardwareProfile": {
                      "$ref": "#/definitions/HardwareProfile",
                      "metadata": {
                        "description": "Specifies the hardware profile for the virtual machine"
                      }
                    },
                    "additionalCapabilities": {
                      "$ref": "#/definitions/AdditionalCapabilities",
                      "metadata": {
                        "description": "Specifies the additional capabilities for the virtual machine"
                      }
                    },
                    "securityProfile": {
                      "$ref": "#/definitions/SecurityProfile",
                      "metadata": {
                        "description": "Specifies the security profile for the virtual machine"
                      }
                    },
                    "networkProfile": {
                      "$ref": "#/definitions/NetworkProfile",
                      "metadata": {
                        "description": "Specifies the network profile for the virtual machine"
                      }
                    },
                    "diagnosticsProfile": {
                      "$ref": "#/definitions/DiagnosticsProfile",
                      "metadata": {
                        "description": "Specifies the diagnostics profile for the virtual machine"
                      }
                    },
                    "storageProfile": {
                      "$ref": "#/definitions/StorageProfile",
                      "metadata": {
                        "description": "Specifies the storage profile for the virtual machine"
                      }
                    },
                    "adminLoginGroupObjectId": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the AD group object ID for the virtual machine administrator login"
                      }
                    },
                    "sshPublicKey": {
                      "type": "securestring",
                      "metadata": {
                        "description": "Specifies the SSH public key for the virtual machine"
                      }
                    },
                    "enableJit": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Enable Just-in-Time access for the virtual machine"
                      }
                    }
                  },
                  "resources": {
                    "virtualMachine": {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2024-03-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "zones": [
                        "1"
                      ],
                      "properties": {
                        "hardwareProfile": "[parameters('hardwareProfile')]",
                        "additionalCapabilities": "[parameters('additionalCapabilities')]",
                        "storageProfile": "[parameters('storageProfile')]",
                        "osProfile": {
                          "computerName": "[parameters('name')]",
                          "adminUsername": "[parameters('name')]",
                          "linuxConfiguration": {
                            "disablePasswordAuthentication": true,
                            "ssh": {
                              "publicKeys": [
                                {
                                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('name'))]",
                                  "keyData": "[parameters('sshPublicKey')]"
                                }
                              ]
                            },
                            "provisionVMAgent": true,
                            "patchSettings": {
                              "patchMode": "AutomaticByPlatform",
                              "automaticByPlatformSettings": {
                                "rebootSetting": "IfRequired",
                                "bypassPlatformSafetyChecksOnUserSchedule": false
                              },
                              "assessmentMode": "AutomaticByPlatform"
                            }
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "securityProfile": "[parameters('securityProfile')]",
                        "networkProfile": "[parameters('networkProfile')]",
                        "diagnosticsProfile": "[parameters('diagnosticsProfile')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "tags": "[parameters('tags')]"
                    },
                    "jitPolicy": {
                      "condition": "[parameters('enableJit')]",
                      "type": "Microsoft.Security/locations/jitNetworkAccessPolicies",
                      "apiVersion": "2020-01-01",
                      "name": "[format('{0}/{1}', parameters('location'), parameters('name'))]",
                      "kind": "Basic",
                      "properties": {
                        "virtualMachines": [
                          {
                            "id": "[resourceId('Microsoft.Compute/virtualMachines', parameters('name'))]",
                            "ports": [
                              {
                                "number": 22,
                                "protocol": "*",
                                "allowedSourceAddressPrefix": "*",
                                "maxRequestAccessDuration": "PT8H"
                              }
                            ]
                          }
                        ]
                      },
                      "dependsOn": [
                        "virtualMachine"
                      ]
                    },
                    "aadLoginExtension": {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-03-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'AADSSHLoginForLinux')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADSSHLoginForLinux",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "virtualMachine"
                      ]
                    },
                    "vmAdminLoginRoleDefinition": {
                      "existing": true,
                      "type": "Microsoft.Authorization/roleDefinitions",
                      "apiVersion": "2022-04-01",
                      "subscriptionId": "[subscription().subscriptionId]",
                      "name": "1c0163c0-47e6-4577-8991-ea5c82e286e4",
                      "metadata": {
                        "description": "This is the built-in Virtual Machine Administrator Login role. See https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#compute"
                      }
                    },
                    "roleAssignment": {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('name'))]",
                      "name": "[guid(resourceId('Microsoft.Compute/virtualMachines', parameters('name')), parameters('adminLoginGroupObjectId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1c0163c0-47e6-4577-8991-ea5c82e286e4'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1c0163c0-47e6-4577-8991-ea5c82e286e4')]",
                        "principalId": "[parameters('adminLoginGroupObjectId')]",
                        "principalType": "Group"
                      },
                      "dependsOn": [
                        "virtualMachine"
                      ]
                    }
                  }
                }
              },
              "dependsOn": [
                "networkInterface"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup",
        "vnet"
      ]
    },
    "copySecrets": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "copySecrets",
      "resourceGroup": "[format('{0}-rg', variables('namePrefix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "srcKeyVaultKeys": {
            "value": "[parameters('keyVaultSourceKeys')]"
          },
          "srcKeyVaultName": {
            "value": "[variables('srcKeyVault').name]"
          },
          "srcKeyVaultRGNName": {
            "value": "[variables('srcKeyVault').resourceGroupName]"
          },
          "srcKeyVaultSubId": {
            "value": "[variables('srcKeyVault').subscriptionId]"
          },
          "destKeyVaultName": {
            "value": "[reference('environmentKeyVault').outputs.name.value]"
          },
          "secretPrefix": {
            "value": "[format('dialogporten--{0}--', parameters('environment'))]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.36.177.2456",
              "templateHash": "14362791978504642027"
            }
          },
          "parameters": {
            "srcKeyVaultKeys": {
              "type": "array"
            },
            "srcKeyVaultName": {
              "type": "string"
            },
            "srcKeyVaultRGNName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "srcKeyVaultSubId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]"
            },
            "destKeyVaultName": {
              "type": "string"
            },
            "destKeyVaultRGName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "destKeyVaultSubId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]"
            },
            "secretPrefix": {
              "type": "string"
            },
            "removeSecretPrefix": {
              "type": "bool",
              "defaultValue": true
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to apply to the resources"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "environmentKeys",
                "count": "[length(parameters('srcKeyVaultKeys'))]",
                "input": {
                  "isEnvironemntKey": "[startsWith(parameters('srcKeyVaultKeys')[copyIndex('environmentKeys')], parameters('secretPrefix'))]",
                  "value": "[if(parameters('removeSecretPrefix'), replace(parameters('srcKeyVaultKeys')[copyIndex('environmentKeys')], parameters('secretPrefix'), ''), parameters('srcKeyVaultKeys')[copyIndex('environmentKeys')])]",
                  "fullName": "[parameters('srcKeyVaultKeys')[copyIndex('environmentKeys')]]"
                }
              }
            ]
          },
          "resources": {
            "srcKeyVaultResource": {
              "existing": true,
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "subscriptionId": "[parameters('srcKeyVaultSubId')]",
              "resourceGroup": "[parameters('srcKeyVaultRGNName')]",
              "name": "[parameters('srcKeyVaultName')]"
            },
            "secrets": {
              "copy": {
                "name": "secrets",
                "count": "[length(variables('environmentKeys'))]"
              },
              "condition": "[variables('environmentKeys')[copyIndex()].isEnvironemntKey]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[variables('environmentKeys')[copyIndex()].value]",
              "subscriptionId": "[parameters('destKeyVaultSubId')]",
              "resourceGroup": "[parameters('destKeyVaultRGName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "destKeyVaultName": {
                    "value": "[parameters('destKeyVaultName')]"
                  },
                  "secretName": {
                    "value": "[variables('environmentKeys')[copyIndex()].value]"
                  },
                  "secretValue": {
                    "reference": {
                      "keyVault": {
                        "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('srcKeyVaultSubId'), parameters('srcKeyVaultRGNName')), 'Microsoft.KeyVault/vaults', parameters('srcKeyVaultName'))]"
                      },
                      "secretName": "[variables('environmentKeys')[copyIndex()].fullName]"
                    }
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.1-experimental",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
                    "_EXPERIMENTAL_FEATURES_ENABLED": [
                      "Asserts"
                    ],
                    "_generator": {
                      "name": "bicep",
                      "version": "0.36.177.2456",
                      "templateHash": "3841694917037618761"
                    }
                  },
                  "parameters": {
                    "destKeyVaultName": {
                      "type": "string"
                    },
                    "secretName": {
                      "type": "string"
                    },
                    "secretValue": {
                      "type": "securestring"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to apply to the resources"
                      }
                    }
                  },
                  "resources": {
                    "secret": {
                      "type": "Microsoft.KeyVault/vaults/secrets",
                      "apiVersion": "2023-07-01",
                      "name": "[format('{0}/{1}', parameters('destKeyVaultName'), parameters('secretName'))]",
                      "properties": {
                        "value": "[parameters('secretValue')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  },
                  "outputs": {
                    "secretUri": {
                      "type": "string",
                      "value": "[reference('secret').secretUri]"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "environmentKeyVault",
        "resourceGroup"
      ]
    }
  },
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[format('{0}-rg', variables('namePrefix'))]"
    },
    "postgreServerName": {
      "type": "string",
      "value": "[reference('postgresql').outputs.serverName.value]"
    },
    "appInsightsSourceMapStorageAccountName": {
      "type": "string",
      "value": "[reference('appInsights').outputs.sourceMapStorageAccountName.value]"
    },
    "appInsightsSourceMapContainerName": {
      "type": "string",
      "value": "[reference('appInsights').outputs.sourceMapContainerName.value]"
    },
    "appConfigurationName": {
      "type": "string",
      "value": "[reference('appConfiguration').outputs.name.value]"
    },
    "appConfigurationEndpoint": {
      "type": "string",
      "value": "[reference('appConfiguration').outputs.endpoint.value]"
    }
  }
}