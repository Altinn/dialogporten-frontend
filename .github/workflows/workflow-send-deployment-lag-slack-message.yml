name: Send Deployment Lag Slack Message

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      staging_version:
        required: true
        type: string
        description: "Current staging version"
      prod_version:
        required: true
        type: string
        description: "Current production version"
      days_since_prod_deploy:
        required: true
        type: string
        description: "Days since last production deployment"
      release_count_diff:
        required: true
        type: string
        description: "Number of releases production is behind"
      compare_url:
        required: true
        type: string
        description: "URL to compare the versions"
      commits_json:
        required: false
        type: string
        description: "JSON array of commits between versions"
        default: "[]"
      commit_authors:
        required: false
        type: string
        description: "Comma-separated list of commit authors"
        default: ""
    secrets:
      SLACK_BOT_TOKEN:
        required: true
      SLACK_CHANNEL_ID:
        required: true

jobs:
  send-slack-message:
    name: Send Deployment Lag Slack Message
    runs-on: ubuntu-latest
    steps:
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Determine severity and styling
        id: determine-severity
        run: |
          days=${{ inputs.days_since_prod_deploy }}
          releases=${{ inputs.release_count_diff }}

          # Simplified severity determination
          if [ "$days" -gt 7 ] || [ "$releases" -gt 5 ]; then
            severity="Attention needed"
            color="#FF6B6B"
            emoji="ðŸš¨"
          elif [ "$days" -gt 3 ] || [ "$releases" -gt 3 ]; then
            severity="Worth noting"
            color="#FFB347"
            emoji="âš ï¸"
          else
            severity="FYI"
            color="#87CEEB"
            emoji="â„¹ï¸"
          fi

          echo "severity=$severity" >> $GITHUB_OUTPUT
          echo "color=$color" >> $GITHUB_OUTPUT
          echo "emoji=$emoji" >> $GITHUB_OUTPUT

      - name: Format commit summary
        id: format-commits
        env:
          COMMITS_JSON: ${{ inputs.commits_json }}
        run: |
          # Write commits_json to a temporary file to avoid shell parsing issues
          # Using env var to prevent command injection
          cat > /tmp/commits.json << EOL
          $COMMITS_JSON
          EOL

          if [ ! -s /tmp/commits.json ] || [ "$(cat /tmp/commits.json)" = "[]" ]; then
            echo "commits_summary=No commit details available" >> $GITHUB_OUTPUT
          else
            # Format commits for Slack (limit to 10 most recent)
            # Use literal \n in the string for Slack's mrkdwn format
            commits_summary=$(jq -r '
              .[0:10] | map("â€¢ `\(.sha)` \(.message) - \(.author)") | join("\\n")
            ' /tmp/commits.json)
            
            # Add note if there are more commits
            total_commits=$(jq length /tmp/commits.json)
            if [ "$total_commits" -gt 10 ]; then
              commits_summary="$commits_summary\\n\\n_... and $((total_commits - 10)) more commits_"
            fi
            
            # Output as a single line with escaped newlines for JSON compatibility
            echo "commits_summary=$commits_summary" >> $GITHUB_OUTPUT
          fi

      - name: Format author mentions
        id: format-authors
        env:
          COMMIT_AUTHORS: ${{ inputs.commit_authors }}
        run: |
          if [ -z "$COMMIT_AUTHORS" ]; then
            echo "commit_authors_mentions=No authors available" >> $GITHUB_OUTPUT
          else
            # Convert comma-separated authors to Slack mentions
            mentions=$(echo "$COMMIT_AUTHORS" | tr ',' '\n' | sed 's/^/@/' | tr '\n' ' ' | sed 's/ $//')
            echo "commit_authors_mentions=$mentions" >> $GITHUB_OUTPUT
          fi

      - name: Create deploy URL
        id: create-deploy-url
        run: |
          deploy_url="https://github.com/${{ github.repository }}/actions/workflows/ci-cd-prod.yml"
          echo "deploy_url=$deploy_url" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          STAGING_VERSION: ${{ inputs.staging_version }}
          PROD_VERSION: ${{ inputs.prod_version }}
          DAYS_SINCE_PROD_DEPLOY: ${{ inputs.days_since_prod_deploy }}
          RELEASE_COUNT_DIFF: ${{ inputs.release_count_diff }}
          COMPARE_URL: ${{ inputs.compare_url }}
          DEPLOY_URL: ${{ steps.create-deploy-url.outputs.deploy_url }}
          SEVERITY: ${{ steps.determine-severity.outputs.severity }}
          COLOR: ${{ steps.determine-severity.outputs.color }}
          EMOJI: ${{ steps.determine-severity.outputs.emoji }}
          COMMITS_SUMMARY: ${{ steps.format-commits.outputs.commits_summary }}
          COMMIT_AUTHORS_MENTIONS: ${{ steps.format-authors.outputs.commit_authors_mentions }}
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload-templated: true
          payload-file-path: "./.github/slack-templates/deployment-lag-notification.json"
